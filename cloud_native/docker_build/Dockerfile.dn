FROM docker.1ms.run/ubuntu:24.04
RUN apt-get -y update && echo -e "Asia\nShanghai" | apt-get install -y tzdata && \
    apt-get install -y locales && locale-gen en_US.UTF-8

ENV TZ=Asia/Shanghai \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8
RUN apt-get install -y gdb vim tar python3 python3-pip libreadline-dev liblz4-dev libzstd-dev libssl-dev \
    libboost-thread-dev libboost-system-dev
RUN apt-get install -y linux-tools-common linux-tools-generic net-tools
RUN apt-get install -y numactl
# 安装 PostgreSQL 编译依赖
RUN apt-get install -y build-essential libreadline-dev liblz4-dev libzstd-dev libssl-dev flex bison wget

# 从源码编译安装 PostgreSQL 17
ARG PG_VERSION=17.2
ARG PG_DOWNLOAD_URL=https://ftp.postgresql.org/pub/source/v${PG_VERSION}/postgresql-${PG_VERSION}.tar.gz

RUN wget -O- "${PG_DOWNLOAD_URL}" | tar -xzvf - -C /tmp && \
    cd /tmp/postgresql-${PG_VERSION} && \
    ./configure --prefix=/usr/local/pgsql --without-icu --enable-debug && \
    make -j$(nproc) && make install && \
    rm -rf /tmp/postgresql-${PG_VERSION}

# 设置 PostgreSQL 环境变量
ENV PATH=/usr/local/pgsql/bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/pgsql/lib \
    PGDATA=/usr/local/pgsql/data

# 安装 Python 依赖
RUN pip3 install --break-system-packages psycopg2 && \
    pip3 install --break-system-packages kazoo && \
    pip3 install --break-system-packages requests

RUN mkdir /opt/falcon && chmod -R 0755 /opt/falcon
ARG USER_NAME=falconMeta
RUN useradd -m -s /bin/bash $USER_NAME

# 后续步骤变更频繁，使用构建缓存破坏参数避免缓存影响
ARG CACHE_BUST
RUN echo "Cache bust: ${CACHE_BUST:-no-bust}"

# 复制完整安装包到统一路径 (构建上下文是 docker_build/)
COPY --chown=$USER_NAME:$USER_NAME falconfs /usr/local/falconfs/

# 创建必要的目录
RUN mkdir /usr/local/falconfs/readiness/ && mkdir /usr/local/falconfs/data/

ENV TMOUT=0
ENV FALCONFS_INSTALL_DIR=/usr/local/falconfs
ENV NODE_TYPE=dn

# 设置脚本执行权限
RUN chmod +x /usr/local/falconfs/falcon_dn/docker-entrypoint.sh && \
    chmod +x /usr/local/falconfs/falcon_dn/start.sh && \
    chmod +x /usr/local/falconfs/falcon_dn/rm_logs.sh && \
    chmod +x /usr/local/falconfs/falcon_dn/check_liveness.sh

USER root
EXPOSE 5432
ENTRYPOINT ["/usr/local/falconfs/falcon_dn/docker-entrypoint.sh"]
